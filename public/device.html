<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>Device Details - SAJ Solar Monitor</title>
  <link rel="stylesheet" href="/design-system/styles.css">
  <style>
    body {
      padding-bottom: 80px;
    }

    .device-header {
      background: var(--color-bg-secondary);
      padding: var(--space-4);
      margin: -16px -16px var(--space-4) -16px;
      border-bottom: 1px solid var(--color-bg-tertiary);
    }

    .device-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: var(--space-1);
    }

    .device-subtitle {
      color: var(--color-text-secondary);
      font-size: 14px;
    }

    .chart-container {
      background: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      border: 1px solid var(--color-bg-tertiary);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .chart-period {
      color: var(--color-text-secondary);
      font-size: 12px;
    }

    .chart-placeholder {
      height: 200px;
      background: linear-gradient(135deg, var(--color-bg-tertiary), var(--color-bg-primary));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
      border: 2px dashed var(--color-bg-tertiary);
    }

    .energy-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .stat-card {
      background: var(--color-bg-secondary);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      text-align: center;
      border: 1px solid var(--color-bg-tertiary);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--color-solar-energy);
      margin-bottom: var(--space-1);
    }

    .stat-label {
      color: var(--color-text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .error-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-secondary);
    }

    .back-button {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-text-secondary);
      text-decoration: none;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/devices" class="back-button">‚Üê</a>
    <h1 class="header-title">üìä Device Details</h1>
    <button id="refreshBtn" class="btn btn-ghost btn-sm">
      <span id="refreshIcon">üîÑ</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Device Info -->
    <section class="mb-6">
      <div class="device-header">
        <div>
          <div class="device-title" id="deviceName">Loading...</div>
          <div class="device-subtitle" id="deviceInfo">Loading device information...</div>
        </div>
        <div id="deviceStatus" class="badge badge-online">Online</div>
      </div>
    </section>

    <!-- Energy Statistics -->
    <section class="mb-6">
      <div class="energy-stats">
        <div class="stat-card">
          <div class="stat-value" id="todayEnergy">--</div>
          <div class="stat-label">Today (kWh)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalEnergy">--</div>
          <div class="stat-label">Total (kWh)</div>
        </div>
      </div>
    </section>

    <!-- Historical Charts -->
    <section class="mb-6">
      <h3 class="text-h3 mb-4">Historical Data</h3>

      <!-- Yesterday Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div>
            <div class="chart-title">üìÖ Yesterday</div>
            <div class="chart-period" id="yesterdayPeriod">Loading...</div>
          </div>
          <button id="refreshYesterday" class="btn btn-ghost btn-sm">üîÑ</button>
        </div>
        <div class="chart-placeholder" id="yesterdayChart">
          <div>üìä Loading yesterday's data...</div>
        </div>
      </div>

      <!-- Last 7 Days Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div>
            <div class="chart-title">üìà Last 7 Days</div>
            <div class="chart-period" id="weekPeriod">Loading...</div>
          </div>
          <button id="refreshWeek" class="btn btn-ghost btn-sm">üîÑ</button>
        </div>
        <div class="chart-placeholder" id="weekChart">
          <div>üìä Loading 7-day data...</div>
        </div>
      </div>

      <!-- Last Month Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div>
            <div class="chart-title">üìä Last Month</div>
            <div class="chart-period" id="monthPeriod">Loading...</div>
          </div>
          <button id="refreshMonth" class="btn btn-ghost btn-sm">üîÑ</button>
        </div>
        <div class="chart-placeholder" id="monthChart">
          <div>üìä Loading monthly data...</div>
        </div>
      </div>
    </section>

    <!-- Error State -->
    <div id="errorState" class="error-state" style="display: none;">
      <p>Unable to load device data. Please check the device SN and try again.</p>
      <button id="retryBtn" class="btn btn-primary mt-4">Retry</button>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <div class="nav-icon">üè†</div>
      <span>Dashboard</span>
    </a>
    <a href="/devices" class="nav-item nav-item-active">
      <div class="nav-icon">üì±</div>
      <span>Devices</span>
    </a>
    <a href="/sync" class="nav-item">
      <div class="nav-icon">üîÑ</div>
      <span>Sync</span>
    </a>
    <a href="/settings" class="nav-item">
      <div class="nav-icon">‚öôÔ∏è</div>
      <span>Settings</span>
    </a>
  </nav>

  <script>
    // Device Details functionality
    class DeviceDetails {
      constructor() {
        this.deviceSn = this.getDeviceSnFromUrl();
        this.init();
      }

      getDeviceSnFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/device\/(.+)/);
        return match ? match[1] : null;
      }

      async init() {
        if (!this.deviceSn) {
          this.showError('Invalid device SN');
          return;
        }

        await this.loadDeviceData();
        this.setupEventListeners();
      }

      setupEventListeners() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.addEventListener('click', () => this.refreshAllData());

        // Individual chart refresh buttons
        document.getElementById('refreshYesterday').addEventListener('click', () => this.loadYesterdayChart());
        document.getElementById('refreshWeek').addEventListener('click', () => this.loadWeekChart());
        document.getElementById('refreshMonth').addEventListener('click', () => this.loadMonthChart());

        // Retry button
        document.getElementById('retryBtn').addEventListener('click', () => this.init());
      }

      async loadDeviceData() {
        try {
          this.showLoading(true);

          // Load device info
          await this.loadDeviceInfo();

          // Load all charts
          await Promise.all([
            this.loadYesterdayChart(),
            this.loadWeekChart(),
            this.loadMonthChart()
          ]);

        } catch (error) {
          console.error('Failed to load device data:', error);
          this.showError('Failed to load device data');
        } finally {
          this.showLoading(false);
        }
      }

      async loadDeviceInfo() {
        try {
          // Get device info from our database
          const response = await fetch(`/api/devices/${this.deviceSn}`);
          if (!response.ok) throw new Error('Device not found');

          const device = await response.json();
          this.updateDeviceInfo(device);

          // Also try to get real-time data for current stats
          await this.loadRealtimeData();

        } catch (error) {
          console.error('Failed to load device info:', error);
          // Try to get basic info from URL parameter
          document.getElementById('deviceName').textContent = `Device ${this.deviceSn}`;
          document.getElementById('deviceInfo').textContent = 'Device information not available';
        }
      }

      async loadRealtimeData() {
        try {
          const response = await fetch(`/api/devices/${this.deviceSn}/realtime`);
          if (response.ok) {
            const realtimeData = await response.json();
            this.updateRealtimeStats(realtimeData);
          }
        } catch (error) {
          console.log('Real-time data not available, using placeholder');
          // Keep placeholder values
        }
      }

      async loadYesterdayChart() {
        try {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);

          const startTime = yesterday.toISOString().slice(0, 19).replace('T', ' ');
          const endTime = new Date(yesterday.getTime() + 24 * 60 * 60 * 1000 - 1000).toISOString().slice(0, 19).replace('T', ' ');

          const response = await fetch(`/api/devices/${this.deviceSn}/historical?startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`);

          if (response.ok) {
            const data = await response.json();
            console.log('Yesterday data loaded:', data); // Debug log
            this.renderChart('yesterdayChart', data, 'Yesterday\'s Generation');
            document.getElementById('yesterdayPeriod').textContent = yesterday.toLocaleDateString();
          } else {
            const errorText = await response.text();
            console.error('Yesterday API error:', response.status, errorText);
            this.showChartError('yesterdayChart', `Failed to load yesterday's data (${response.status})`);
          }
        } catch (error) {
          console.error('Failed to load yesterday chart:', error);
          this.showChartError('yesterdayChart', 'Error loading yesterday\'s data');
        }
      }

      async loadWeekChart() {
        try {
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(endDate.getDate() - 7);

          const startTime = startDate.toISOString().slice(0, 19).replace('T', ' ');
          const endTime = endDate.toISOString().slice(0, 19).replace('T', ' ');

          const response = await fetch(`/api/devices/${this.deviceSn}/historical?startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`);

          if (response.ok) {
            const data = await response.json();
            this.renderChart('weekChart', data, '7-Day Generation Trend');
            document.getElementById('weekPeriod').textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
          } else {
            this.showChartError('weekChart', 'Failed to load 7-day data');
          }
        } catch (error) {
          console.error('Failed to load week chart:', error);
          this.showChartError('weekChart', 'Error loading 7-day data');
        }
      }

      async loadMonthChart() {
        try {
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(endDate.getDate() - 30);

          const startTime = startDate.toISOString().slice(0, 19).replace('T', ' ');
          const endTime = endDate.toISOString().slice(0, 19).replace('T', ' ');

          const response = await fetch(`/api/devices/${this.deviceSn}/historical?startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`);

          if (response.ok) {
            const data = await response.json();
            this.renderChart('monthChart', data, '30-Day Generation Trend');
            document.getElementById('monthPeriod').textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
          } else {
            this.showChartError('monthChart', 'Failed to load monthly data');
          }
        } catch (error) {
          console.error('Failed to load month chart:', error);
          this.showChartError('monthChart', 'Error loading monthly data');
        }
      }

      updateDeviceInfo(device) {
        document.getElementById('deviceName').textContent = device.plant_name || `Device ${device.device_sn}`;
        document.getElementById('deviceInfo').textContent = `${device.device_type} ‚Ä¢ ${device.country}`;

        const statusElement = document.getElementById('deviceStatus');
        if (device.is_alarm) {
          statusElement.textContent = 'Alarm';
          statusElement.className = 'badge badge-alarm';
        } else {
          statusElement.textContent = device.is_online ? 'Online' : 'Offline';
          statusElement.className = `badge ${device.is_online ? 'badge-online' : 'badge-offline'}`;
        }
      }

      updateRealtimeStats(realtimeData) {
        if (realtimeData.todayPvEnergy) {
          document.getElementById('todayEnergy').textContent = parseFloat(realtimeData.todayPvEnergy).toFixed(2);
        }
        if (realtimeData.totalPvEnergy) {
          document.getElementById('totalEnergy').textContent = parseFloat(realtimeData.totalPvEnergy).toFixed(1);
        }
      }

      renderChart(chartId, data, title) {
        const chartElement = document.getElementById(chartId);
        console.log(`Rendering chart ${chartId} with title: ${title}`);
        console.log('Data received:', data);
        
        // Remove chart-placeholder styling to avoid dual container effect
        chartElement.style.background = 'none';
        chartElement.style.border = 'none';
        chartElement.style.height = 'auto';
        chartElement.style.display = 'block';
        chartElement.style.padding = '0';
        chartElement.style.alignItems = 'initial';
        chartElement.style.justifyContent = 'initial';

        // Check if data exists and has the correct structure
        if (!data || data.code !== 200) {
          console.error(`Invalid data format for ${chartId}:`, data);
          chartElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">‚ùå Invalid data format</div>';
          return;
        }

        // For historical data, the data array is directly in response.data
        // For real-time data, response.data is a single object
        let dataPoints = [];
        if (Array.isArray(data.data)) {
          // Historical data - array of data points
          dataPoints = data.data;
        } else if (data.data && typeof data.data === 'object') {
          // Real-time data - single object, convert to array for consistency
          dataPoints = [data.data];
        }

        if (dataPoints.length === 0) {
          chartElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">üìä No data available for this period</div>';
          return;
        }

        // Simple bar chart visualization
        const maxPower = Math.max(...dataPoints.map(d => parseFloat(d.totalPVPower) || 0));

        if (maxPower === 0) {
          chartElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">üìä No power generation data available</div>';
          return;
        }

        // Create smooth area chart with SVG (like reference design)
        const chartHeight = 200;
        
        // Create fixed time grid from 5am to 9pm (16 hours)
        const createTimeGrid = () => {
          const startHour = 5; // 5am
          const endHour = 21;  // 9pm
          const timePoints = [];
          
          for (let hour = startHour; hour <= endHour; hour++) {
            const timeLabel = `${hour.toString().padStart(2, '0')}:00`;
            timePoints.push({
              hour,
              timeLabel,
              x: ((hour - startHour) / (endHour - startHour)) * 100,
              power: 0 // default to 0, will be updated with real data
            });
          }
          
          return timePoints;
        };
        
        const timeGrid = createTimeGrid();
        
        // Map actual data to time grid
        dataPoints.forEach(point => {
          const pointTime = new Date(point.dataTime);
          const pointHour = pointTime.getHours();
          const power = parseFloat(point.totalPVPower) || 0;
          
          // Find closest hour in our time grid
          const gridPoint = timeGrid.find(tp => tp.hour === pointHour);
          if (gridPoint) {
            gridPoint.power = Math.max(gridPoint.power, power); // Take maximum power for that hour
          }
        });
        
        // Generate SVG path for smooth curve using time grid
        let pathData = '';
        let areaPath = '';
        const points = timeGrid.map(gridPoint => ({
          x: gridPoint.x,
          y: ((maxPower - gridPoint.power) / maxPower) * 80 + 10, // 10% padding top/bottom
          power: gridPoint.power,
          time: gridPoint.timeLabel,
          hour: gridPoint.hour
        }));

        if (points.length > 0) {
          // Create smooth curve using quadratic bezier curves
          pathData = `M ${points[0].x} ${points[0].y}`;
          areaPath = `M ${points[0].x} 90 L ${points[0].x} ${points[0].y}`;
          
          for (let i = 1; i < points.length; i++) {
            const prevPoint = points[i - 1];
            const currentPoint = points[i];
            
            // Control point for smooth curve (midpoint technique)
            const cpX = (prevPoint.x + currentPoint.x) / 2;
            pathData += ` Q ${cpX} ${prevPoint.y} ${currentPoint.x} ${currentPoint.y}`;
            areaPath += ` Q ${cpX} ${prevPoint.y} ${currentPoint.x} ${currentPoint.y}`;
          }
          
          // Close the area path
          areaPath += ` L ${points[points.length - 1].x} 90 Z`;
        }

        let chartHTML = `
          <div style="padding: 20px; background: #1e293b; border-radius: 12px; margin: 8px 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <div style="font-size: 14px; color: #cbd5e1; margin-bottom: 20px; text-align: center; font-weight: 500;">
              ${title} (${dataPoints.length} data points)
            </div>
            
            <!-- SVG Chart Container -->
            <div style="position: relative; height: ${chartHeight}px; margin-bottom: 20px; background: #0f172a; border-radius: 8px; padding: 16px;">
              <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible; display: block;">
                <!-- Grid lines (optional) -->
                <defs>
                  <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#2563eb;stop-opacity:0.9" />
                    <stop offset="25%" style="stop-color:#3b82f6;stop-opacity:0.6" />
                    <stop offset="75%" style="stop-color:#1e40af;stop-opacity:0.3" />
                    <stop offset="100%" style="stop-color:#1e3a8a;stop-opacity:0.1" />
                  </linearGradient>
                </defs>
                
                <!-- Area fill -->
                ${areaPath ? `<path d="${areaPath}" fill="url(#areaGradient)" />` : ''}
                
                <!-- Line stroke -->
                ${pathData ? `<path d="${pathData}" fill="none" stroke="#2563eb" stroke-width="1" />` : ''}
                
                <!-- Data points (dots) -->
                ${points.map(point => `
                  <circle cx="${point.x}" cy="${point.y}" r="0.4" fill="#2563eb" opacity="0.9">
                    <title>${point.time}: ${point.power.toFixed(0)}W</title>
                  </circle>
                `).join('')}
              </svg>
              
              <!-- Time labels -->
              <div style="position: absolute; bottom: -25px; left: 16px; right: 16px; display: flex; justify-content: space-between;">
                ${points.filter((_, i) => i % 3 === 0).map(point => `
                  <span style="font-size: 10px; color: #64748b; text-align: center; min-width: 30px;">
                    ${point.time}
                  </span>
                `).join('')}
              </div>
            </div>
            
            <!-- Chart Summary -->
            <div style="
              border-top: 1px solid #334155; 
              padding-top: 16px; 
              font-size: 13px; 
              color: #cbd5e1;
              display: flex;
              justify-content: space-between;
              flex-wrap: wrap;
              gap: 12px;
            ">
              <div style="display: flex; align-items: center; gap: 6px;">
                <div style="width: 8px; height: 8px; background: #2563eb; border-radius: 50%;"></div>
                <span><strong>Peak:</strong> ${maxPower.toFixed(0)}W</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></div>
                <span><strong>Avg:</strong> ${(dataPoints.reduce((sum, d) => sum + (parseFloat(d.totalPVPower) || 0), 0) / dataPoints.length).toFixed(0)}W</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <div style="width: 8px; height: 8px; background: #1e40af; border-radius: 50%;"></div>
                <span><strong>Energy:</strong> ${(dataPoints.reduce((sum, d) => sum + (parseFloat(d.todayPvEnergy) || 0), 0)).toFixed(2)}kWh</span>
              </div>
            </div>
          </div>
        `;

        chartElement.innerHTML = chartHTML;
      }

      showChartError(chartId, message) {
        const chartElement = document.getElementById(chartId);
        chartElement.innerHTML = `<div style="color: var(--color-solar-alarm);">‚ö†Ô∏è ${message}</div>`;
      }

      async refreshAllData() {
        const refreshIcon = document.getElementById('refreshIcon');
        refreshIcon.style.animation = 'spin 1s linear infinite';

        await this.loadDeviceData();

        setTimeout(() => {
          refreshIcon.style.animation = '';
        }, 1000);
      }

      showLoading(loading) {
        document.body.classList.toggle('loading', loading);
      }

      showError(message) {
        document.getElementById('errorState').style.display = 'block';
        document.querySelector('main').style.display = 'none';
        console.error(message);
      }
    }

    // Initialize device details when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new DeviceDetails();
    });
  </script>
</body>
</html>