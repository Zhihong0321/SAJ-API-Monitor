<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>Sync Plants - SAJ Solar Monitor</title>
  <link rel="stylesheet" href="/design-system/styles.css">
  <style>
    .sync-progress {
      background-color: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      height: 8px;
      overflow: hidden;
      margin: var(--space-4) 0;
    }
    
    .sync-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary-500), var(--color-solar-energy));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .sync-log {
      background-color: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      font-family: var(--font-family-mono);
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
      margin: var(--space-4) 0;
    }
    
    .sync-step {
      margin-bottom: var(--space-2);
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      background-color: var(--color-bg-secondary);
    }
    
    .sync-step.active {
      background-color: var(--color-primary-500);
      color: white;
    }
    
    .sync-step.completed {
      background-color: var(--color-solar-online);
      color: white;
    }
    
    .sync-step.error {
      background-color: var(--color-solar-alarm);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/" class="btn btn-ghost btn-sm">‚Üê Back</a>
    <h1 class="header-title">Sync Plants</h1>
    <div></div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Sync Status Card -->
    <section class="mb-6">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Plant Synchronization</h2>
          <span id="syncStatus" class="badge badge-offline">Ready</span>
        </div>
        <div class="card-content">
          <p class="text-body-small mb-4">
            Synchronize your plant list with the SAJ API server. This will fetch all registered plants and add new ones to your local database.
          </p>
          
          <!-- Progress Bar -->
          <div class="sync-progress">
            <div id="progressBar" class="sync-progress-bar"></div>
          </div>
          
          <!-- Sync Button -->
          <div class="text-center">
            <button id="syncBtn" class="btn btn-primary btn-lg">
              <span id="syncBtnText">Start Sync</span>
              <span id="syncSpinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Sync Steps -->
    <section class="mb-6">
      <h3 class="text-h3 mb-4">Sync Progress</h3>
      <div id="syncSteps">
        <div class="sync-step" data-step="token">
          <div class="flex items-center gap-3">
            <div>üîë</div>
            <div>
              <div class="text-body">Get Access Token</div>
              <div class="text-caption">Authenticating with SAJ API</div>
            </div>
          </div>
        </div>
        
        <div class="sync-step" data-step="plants">
          <div class="flex items-center gap-3">
            <div>üè≠</div>
            <div>
              <div class="text-body">Fetch Plant List</div>
              <div class="text-caption">Retrieving plants from all pages</div>
            </div>
          </div>
        </div>
        
        <div class="sync-step" data-step="database">
          <div class="flex items-center gap-3">
            <div>üíæ</div>
            <div>
              <div class="text-body">Update Database</div>
              <div class="text-caption">Adding new plants to local storage</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sync Results -->
    <section id="syncResults" class="mb-6" style="display: none;">
      <h3 class="text-h3 mb-4">Sync Results</h3>
      <div class="card">
        <div class="card-content">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="text-center">
              <div class="energy-value text-h2" id="totalFetched" style="color: var(--color-text-primary);">--</div>
              <div class="energy-label">Total Fetched</div>
            </div>
            <div class="text-center">
              <div class="energy-value text-h2" id="newPlants" style="color: var(--color-solar-online);">--</div>
              <div class="energy-label">New Plants</div>
            </div>
          </div>
          
          <div id="syncResultMessage" class="text-body-small text-center"></div>
        </div>
      </div>
    </section>

    <!-- Sync Log -->
    <section class="mb-6">
      <h3 class="text-h3 mb-4">Sync Log</h3>
      <div id="syncLog" class="sync-log">
        <div class="text-caption">Ready to start plant synchronization...</div>
      </div>
    </section>

    <!-- Last Sync Info -->
    <section class="mb-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Last Sync</h3>
        </div>
        <div class="card-content">
          <div id="lastSyncInfo" class="text-body-small">
            Loading sync history...
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <div class="nav-icon">üè†</div>
      <span>Dashboard</span>
    </a>
    <a href="/devices" class="nav-item">
      <div class="nav-icon">üì±</div>
      <span>Devices</span>
    </a>
    <a href="/plants" class="nav-item">
      <div class="nav-icon">üè≠</div>
      <span>Plants</span>
    </a>
    <a href="/sync" class="nav-item">
      <div class="nav-icon">üîÑ</div>
      <span>Device Sync</span>
    </a>
    <a href="/plant-sync" class="nav-item nav-item-active">
      <div class="nav-icon">üå±</div>
      <span>Plant Sync</span>
    </a>
  </nav>

  <script>
    // Plant Sync functionality
    class PlantSync {
      constructor() {
        this.isRunning = false;
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadLastSyncInfo();
      }

      setupEventListeners() {
        const syncBtn = document.getElementById('syncBtn');
        syncBtn.addEventListener('click', () => this.startSync());
      }

      async startSync() {
        if (this.isRunning) return;
        
        this.isRunning = true;
        this.updateSyncButton(true);
        this.resetProgress();
        this.logMessage('üöÄ Starting plant synchronization...');

        try {
          // Step 1: Get Access Token (using shared token system)
          this.updateStep('token', 'active');
          this.logMessage('üîë Getting access token from SAJ API...');
          // Plants API uses internal token management, so this step is automatic
          this.updateStep('token', 'completed');
          this.logMessage('‚úÖ Access token ready');
          this.updateProgress(33);

          // Step 2: Fetch Plants
          this.updateStep('plants', 'active');
          this.logMessage('üè≠ Fetching plant list from SAJ API...');
          const plants = await this.fetchAllPlants();
          this.updateStep('plants', 'completed');
          this.logMessage(`‚úÖ Fetched ${plants.length} plants from API`);
          this.updateProgress(66);

          // Step 3: Update Database
          this.updateStep('database', 'active');
          this.logMessage('üíæ Updating local database...');
          const dbResult = await this.updateDatabase(plants);
          this.updateStep('database', 'completed');
          this.logMessage(`‚úÖ Added ${dbResult.newPlants} new plants to database`);
          this.updateProgress(100);

          // Show results
          this.showResults(plants.length, dbResult.newPlants);
          this.updateSyncStatus('success', 'Completed');
          this.logMessage('üéâ Plant synchronization completed successfully!');

        } catch (error) {
          this.handleSyncError(error);
        } finally {
          this.isRunning = false;
          this.updateSyncButton(false);
        }
      }

      async fetchAllPlants() {
        const allPlants = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
          this.logMessage(`üìÑ Fetching page ${page}...`);
          
          const response = await fetch(`/api/saj/plants?pageNum=${page}&pageSize=100`);

          if (!response.ok) {
            throw new Error(`Failed to fetch plants page ${page}: ${response.statusText}`);
          }

          const data = await response.json();
          
          // SAJ plants API returns data directly, not nested in data.rows
          if (data.rows && Array.isArray(data.rows)) {
            allPlants.push(...data.rows);
            this.logMessage(`üìÑ Page ${page}: ${data.rows.length} plants`);
            
            // Check if we have more pages
            hasMore = data.totalPage > page;
            page++;
          } else {
            throw new Error('Invalid plants API response format');
          }
        }

        return allPlants;
      }

      async updateDatabase(plants) {
        const response = await fetch('/api/plants/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ plants })
        });

        if (!response.ok) {
          throw new Error(`Failed to update database: ${response.statusText}`);
        }

        return response.json();
      }

      handleSyncError(error) {
        console.error('Plant sync error:', error);
        this.logMessage(`‚ùå Error: ${error.message}`);
        this.updateSyncStatus('error', 'Failed');
        
        // Mark current step as error
        const activeStep = document.querySelector('.sync-step.active');
        if (activeStep) {
          this.updateStep(activeStep.dataset.step, 'error');
        }
      }

      updateSyncButton(syncing) {
        const btn = document.getElementById('syncBtn');
        const btnText = document.getElementById('syncBtnText');
        const spinner = document.getElementById('syncSpinner');

        btn.disabled = syncing;
        btnText.textContent = syncing ? 'Syncing...' : 'Start Sync';
        spinner.style.display = syncing ? 'inline-block' : 'none';
      }

      updateStep(stepName, status) {
        const step = document.querySelector(`[data-step="${stepName}"]`);
        if (step) {
          step.className = `sync-step ${status}`;
        }
      }

      resetProgress() {
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('syncResults').style.display = 'none';
        
        // Reset all steps
        document.querySelectorAll('.sync-step').forEach(step => {
          step.className = 'sync-step';
        });
      }

      updateProgress(percent) {
        document.getElementById('progressBar').style.width = `${percent}%`;
      }

      updateSyncStatus(type, text) {
        const status = document.getElementById('syncStatus');
        status.textContent = text;
        status.className = `badge badge-${type === 'success' ? 'online' : type === 'error' ? 'alarm' : 'offline'}`;
      }

      showResults(totalFetched, newPlants) {
        document.getElementById('totalFetched').textContent = totalFetched;
        document.getElementById('newPlants').textContent = newPlants;
        document.getElementById('syncResultMessage').textContent = 
          `Successfully synchronized ${totalFetched} plants. ${newPlants} new plants were added to your system.`;
        document.getElementById('syncResults').style.display = 'block';
      }

      logMessage(message) {
        const log = document.getElementById('syncLog');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span class="text-muted">${timestamp}</span> ${message}`;
        log.appendChild(logEntry);
        log.scrollTop = log.scrollHeight;
      }

      async loadLastSyncInfo() {
        try {
          const response = await fetch('/api/plants/sync/history?limit=1');
          if (response.ok) {
            const history = await response.json();
            if (history.length > 0) {
              const lastSync = history[0];
              const date = new Date(lastSync.sync_completed_at || lastSync.sync_started_at).toLocaleString();
              document.getElementById('lastSyncInfo').innerHTML = `
                <div><strong>Last sync:</strong> ${date}</div>
                <div><strong>Status:</strong> ${lastSync.success ? '‚úÖ Success' : '‚ùå Failed'}</div>
                <div><strong>Plants added:</strong> ${lastSync.new_plants_added || 0}</div>
                ${lastSync.error_message ? `<div class="text-error">Error: ${lastSync.error_message}</div>` : ''}
              `;
            } else {
              document.getElementById('lastSyncInfo').textContent = 'No previous sync found.';
            }
          }
        } catch (error) {
          document.getElementById('lastSyncInfo').textContent = 'Failed to load sync history.';
        }
      }
    }

    // Initialize sync page when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new PlantSync();
    });
  </script>
</body>
</html>