<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>Devices - SAJ Solar Monitor</title>
  <link rel="stylesheet" href="/design-system/styles.css">
  <style>
    body {
      padding-bottom: 80px;
    }

    .device-card {
      background: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      border: 1px solid var(--color-bg-tertiary);
    }

    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .device-title {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .badge {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
    }

    .badge-online {
      background: var(--color-solar-online);
      color: white;
    }

    .badge-offline {
      background: var(--color-solar-offline);
      color: white;
    }

    .badge-alarm {
      background: var(--color-solar-alarm);
      color: white;
    }

    .device-details {
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .device-actions {
      margin-top: var(--space-3);
      display: flex;
      gap: var(--space-2);
    }

    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8) var(--space-4);
      color: var(--color-text-secondary);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: var(--color-bg-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--color-text-primary);
    }

    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .form-input {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-bg-tertiary);
      border-radius: var(--radius-sm);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-solar-online);
    }

    .input-with-button {
      display: flex;
      gap: var(--space-2);
    }

    .input-with-button .form-input {
      flex: 1;
    }

    .test-result {
      margin-top: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-sm);
      font-size: 14px;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .test-result.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .device-preview {
      background: var(--color-bg-secondary);
      border-radius: var(--radius-sm);
      padding: var(--space-3);
      margin-top: var(--space-2);
    }

    .device-preview-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-1);
      font-size: 14px;
    }

    .device-preview-item:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1 class="header-title">üì± Devices</h1>
    <button id="refreshBtn" class="btn btn-ghost btn-sm">
      <span id="refreshIcon">üîÑ</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Device Summary -->
    <section class="mb-6">
      <div class="grid grid-cols-3 gap-3">
        <div class="card text-center">
          <div class="energy-value text-h2" id="totalDevices" style="color: var(--color-text-primary);">--</div>
          <div class="energy-label">Total Devices</div>
        </div>
        <div class="card text-center">
          <div class="energy-value text-h2" id="onlineDevices" style="color: var(--color-solar-online);">--</div>
          <div class="energy-label">Online</div>
        </div>
        <div class="card text-center">
          <div class="energy-value text-h2" id="alarmDevices" style="color: var(--color-solar-alarm);">--</div>
          <div class="energy-label">Alarms</div>
        </div>
      </div>
    </section>

    <!-- Device List -->
    <section class="mb-6">
      <div class="card-header">
        <h3 class="text-h3">Device List</h3>
        <div style="display: flex; gap: var(--space-2);">
          <button id="manualAddBtn" class="btn btn-secondary btn-sm">‚ûï Manual Add Device</button>
          <a href="/sync" class="btn btn-primary btn-sm">Sync Devices</a>
        </div>
      </div>

      <div id="deviceList" class="space-y-3">
        <!-- Devices will be loaded here -->
      </div>

      <div id="loadingState" class="card text-center" style="display: none;">
        <div class="card-content">
          <p class="text-body">Loading devices...</p>
        </div>
      </div>

      <div id="emptyState" class="card text-center" style="display: none;">
        <div class="card-content">
          <p class="text-body-small mb-4">No devices found. Sync devices from SAJ API to get started.</p>
          <a href="/sync" class="btn btn-primary">Sync Devices Now</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Manual Add Device Modal -->
  <div id="manualAddModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Manual Add Device</h3>
        <button id="closeModal" class="modal-close">√ó</button>
      </div>
      
      <form id="addDeviceForm">
        <div class="form-group">
          <label class="form-label" for="deviceSn">Device Serial Number</label>
          <div class="input-with-button">
            <input type="text" id="deviceSn" class="form-input" placeholder="Enter device SN (e.g., XXXXXXXX)" required>
            <button type="button" id="testDeviceBtn" class="btn btn-secondary btn-sm">Test</button>
          </div>
          <div id="testResult" class="test-result" style="display: none;"></div>
          <div id="devicePreview" class="device-preview" style="display: none;"></div>
        </div>

        <div class="form-group">
          <div style="display: flex; gap: var(--space-2); justify-content: flex-end;">
            <button type="button" id="cancelBtn" class="btn btn-ghost">Cancel</button>
            <button type="submit" id="addDeviceSubmitBtn" class="btn btn-primary" disabled>Add Device</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <div class="nav-icon">üè†</div>
      <span>Dashboard</span>
    </a>
    <a href="/devices" class="nav-item nav-item-active">
      <div class="nav-icon">üì±</div>
      <span>Devices</span>
    </a>
    <a href="/plants" class="nav-item">
      <div class="nav-icon">üè≠</div>
      <span>Plants</span>
    </a>
    <a href="/sync" class="nav-item">
      <div class="nav-icon">üîÑ</div>
      <span>Sync</span>
    </a>
    <a href="/settings" class="nav-item">
      <div class="nav-icon">‚öôÔ∏è</div>
      <span>Settings</span>
    </a>
  </nav>

  <script>
    // Device List functionality
    class DeviceList {
      constructor() {
        this.init();
      }

      async init() {
        await this.loadDeviceData();
        this.setupEventListeners();
      }

      setupEventListeners() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.addEventListener('click', () => this.refreshData());

        // Manual add device modal
        const manualAddBtn = document.getElementById('manualAddBtn');
        const modal = document.getElementById('manualAddModal');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');

        manualAddBtn.addEventListener('click', () => this.openManualAddModal());
        closeModal.addEventListener('click', () => this.closeManualAddModal());
        cancelBtn.addEventListener('click', () => this.closeManualAddModal());
        
        // Close modal when clicking overlay
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            this.closeManualAddModal();
          }
        });

        // Device testing
        const testDeviceBtn = document.getElementById('testDeviceBtn');
        testDeviceBtn.addEventListener('click', () => this.testDevice());

        // Form submission
        const addDeviceForm = document.getElementById('addDeviceForm');
        addDeviceForm.addEventListener('submit', (e) => this.addDevice(e));
      }

      async loadDeviceData() {
        try {
          this.showLoading(true);

          // Load device summary
          const deviceSummary = await this.fetchDeviceSummary();
          this.updateDeviceCounts(deviceSummary);

          // Load all devices
          const devices = await this.fetchAllDevices();
          this.renderDeviceList(devices);

        } catch (error) {
          console.error('Failed to load device data:', error);
          this.showError('Failed to load device data');
        } finally {
          this.showLoading(false);
        }
      }

      async fetchDeviceSummary() {
        const response = await fetch('/api/devices/summary');
        if (!response.ok) throw new Error('Failed to fetch device summary');
        return response.json();
      }

      async fetchAllDevices() {
        const response = await fetch('/api/devices?limit=100'); // Get more devices for the list
        if (!response.ok) throw new Error('Failed to fetch devices');
        return response.json();
      }

      updateDeviceCounts(summary) {
        document.getElementById('totalDevices').textContent = summary.total || 0;
        document.getElementById('onlineDevices').textContent = summary.online || 0;
        document.getElementById('alarmDevices').textContent = summary.alarms || 0;
      }

      renderDeviceList(devices) {
        const deviceList = document.getElementById('deviceList');
        const emptyState = document.getElementById('emptyState');

        if (!devices || devices.length === 0) {
          deviceList.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        deviceList.innerHTML = devices.map(device => `
          <div class="device-card">
            <div class="device-header">
              <div class="device-title">${device.plant_name || 'Unknown Plant'}</div>
              <span class="badge ${this.getStatusBadge(device)}">
                ${this.getStatusText(device)}
              </span>
            </div>
            <div class="device-details">
              <div><strong>Device:</strong> ${device.device_sn}</div>
              <div><strong>Type:</strong> ${device.device_type}</div>
              <div><strong>Location:</strong> ${device.country}</div>
              <div><strong>Status:</strong> ${device.is_online ? 'Online' : 'Offline'} ${device.is_alarm ? '(Alarm)' : ''}</div>
            </div>
            <div class="device-actions">
              <a href="/device/${device.device_sn}" class="btn btn-primary btn-sm">
                üìä View Historical Data
              </a>
            </div>
          </div>
        `).join('');
      }

      getStatusBadge(device) {
        if (device.is_alarm) return 'badge-alarm';
        return device.is_online ? 'badge-online' : 'badge-offline';
      }

      getStatusText(device) {
        if (device.is_alarm) return 'Alarm';
        return device.is_online ? 'Online' : 'Offline';
      }

      async refreshData() {
        const refreshIcon = document.getElementById('refreshIcon');
        refreshIcon.style.animation = 'spin 1s linear infinite';

        await this.loadDeviceData();

        setTimeout(() => {
          refreshIcon.style.animation = '';
        }, 1000);
      }

      showLoading(loading) {
        document.body.classList.toggle('loading', loading);
        document.getElementById('loadingState').style.display = loading ? 'block' : 'none';
      }

      showError(message) {
        alert(message);
      }

      // Manual Add Device Modal Methods
      openManualAddModal() {
        const modal = document.getElementById('manualAddModal');
        modal.style.display = 'flex';
        document.getElementById('deviceSn').focus();
        this.resetModal();
      }

      closeManualAddModal() {
        const modal = document.getElementById('manualAddModal');
        modal.style.display = 'none';
        this.resetModal();
      }

      resetModal() {
        document.getElementById('deviceSn').value = '';
        document.getElementById('testResult').style.display = 'none';
        document.getElementById('devicePreview').style.display = 'none';
        document.getElementById('addDeviceSubmitBtn').disabled = true;
        this.testedDevice = null;
      }

      async testDevice() {
        const deviceSn = document.getElementById('deviceSn').value.trim();
        const testResult = document.getElementById('testResult');
        const devicePreview = document.getElementById('devicePreview');
        const testBtn = document.getElementById('testDeviceBtn');
        const submitBtn = document.getElementById('addDeviceSubmitBtn');

        if (!deviceSn) {
          this.showTestResult('error', 'Please enter a device serial number');
          return;
        }

        try {
          testBtn.disabled = true;
          testBtn.textContent = 'Testing...';
          this.showTestResult('loading', 'Testing device connection...');
          devicePreview.style.display = 'none';
          submitBtn.disabled = true;

          const response = await fetch('/api/devices/test', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ deviceSn })
          });

          const result = await response.json();

          if (result.success) {
            this.showTestResult('success', `‚úÖ ${result.message}`);
            this.showDevicePreview(result.device);
            submitBtn.disabled = false;
            this.testedDevice = result.device;
          } else {
            this.showTestResult('error', `‚ùå ${result.error}: ${result.message}`);
            devicePreview.style.display = 'none';
            submitBtn.disabled = true;
            this.testedDevice = null;
          }

        } catch (error) {
          console.error('Failed to test device:', error);
          this.showTestResult('error', `‚ùå Failed to test device: ${error.message}`);
          devicePreview.style.display = 'none';
          submitBtn.disabled = true;
          this.testedDevice = null;
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = 'Test';
        }
      }

      showTestResult(type, message) {
        const testResult = document.getElementById('testResult');
        testResult.className = `test-result ${type}`;
        testResult.textContent = message;
        testResult.style.display = 'block';
      }

      showDevicePreview(device) {
        const devicePreview = document.getElementById('devicePreview');
        devicePreview.innerHTML = `
          <div class="device-preview-item">
            <span><strong>Device SN:</strong></span>
            <span>${device.deviceSn}</span>
          </div>
          <div class="device-preview-item">
            <span><strong>Plant Name:</strong></span>
            <span>${device.plantName}</span>
          </div>
          <div class="device-preview-item">
            <span><strong>Device Type:</strong></span>
            <span>${device.deviceType}</span>
          </div>
          <div class="device-preview-item">
            <span><strong>Country:</strong></span>
            <span>${device.country}</span>
          </div>
          <div class="device-preview-item">
            <span><strong>Status:</strong></span>
            <span>${device.isOnline ? 'Online' : 'Offline'} ${device.isAlarm ? '(Alarm)' : ''}</span>
          </div>
          <div class="device-preview-item">
            <span><strong>Power Now:</strong></span>
            <span>${device.powerNow} W</span>
          </div>
        `;
        devicePreview.style.display = 'block';
      }

      async addDevice(e) {
        e.preventDefault();
        
        if (!this.testedDevice) {
          this.showTestResult('error', 'Please test the device first');
          return;
        }

        const submitBtn = document.getElementById('addDeviceSubmitBtn');
        
        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Adding...';

          const response = await fetch('/api/devices/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              deviceSn: this.testedDevice.deviceSn,
              plantName: this.testedDevice.plantName,
              deviceType: this.testedDevice.deviceType,
              country: this.testedDevice.country
            })
          });

          const result = await response.json();

          if (result.success) {
            this.showTestResult('success', `‚úÖ ${result.message}`);
            
            // Close modal and refresh device list after a short delay
            setTimeout(() => {
              this.closeManualAddModal();
              this.refreshData();
            }, 1500);
          } else {
            this.showTestResult('error', `‚ùå ${result.error}: ${result.message}`);
          }

        } catch (error) {
          console.error('Failed to add device:', error);
          this.showTestResult('error', `‚ùå Failed to add device: ${error.message}`);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Device';
        }
      }
    }

    // Initialize device list when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new DeviceList();
    });
  </script>
</body>
</html>